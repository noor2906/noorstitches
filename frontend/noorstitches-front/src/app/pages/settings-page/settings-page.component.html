<div class="container py-5 separacion-header-home">
  <div class="row mb-5">
    <div class="col-12">
      <div class="row p-0 m-0 divider-con-borde">
        <p class="h3 text-morado-intermedio-1 extrabold">Mi Cuenta</p>
      </div>
    </div>
  </div>

  <!-- Navegación por pestañas -->
  <div class="row mb-4">
    <div class="col-12">
      <ul
        class="nav nav-pills justify-content-start gap-2"
        id="settingsTabs"
        role="tablist"
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active rounded-pill px-4 py-2 text-morado-oscuro border-morado-intermedio-1"
            id="perfil-tab"
            data-bs-toggle="pill"
            data-bs-target="#perfil"
            type="button"
            role="tab"
            aria-controls="perfil"
            aria-selected="true"
          >
            <mat-icon
              class="me-2"
              style="font-size: 18px; height: 18px; width: 18px"
              >person</mat-icon
            >
            Mi Perfil
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link rounded-pill px-4 py-2 text-morado-oscuro border-morado-intermedio-1"
            id="pedidos-tab"
            data-bs-toggle="pill"
            data-bs-target="#pedidos"
            type="button"
            role="tab"
            aria-controls="pedidos"
            aria-selected="false"
          >
            <mat-icon
              class="me-2"
              style="font-size: 18px; height: 18px; width: 18px"
              >shopping_bag</mat-icon
            >
            Mis Pedidos
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Contenido de las pestañas -->
  <div class="tab-content" id="settingsTabsContent">
    <!-- Pestaña Mi Perfil -->
    <div
      class="tab-pane fade show active"
      id="perfil"
      role="tabpanel"
      aria-labelledby="perfil-tab"
    >
      <div class="row g-4">
        <!-- Formulario unificado de perfil -->
        <div class="col-lg-8">
          <form [formGroup]="userForm" (ngSubmit)="guardarCambios()">
            <!-- Información personal -->
            <div class="card border-morado-intermedio-1 rounded-4">
              <div
                class="card-header bg-morado-intermedio-1 text-blanco rounded-top-3"
              >
                <h5 class="mb-0 bold">Información Personal</h5>
              </div>
              <div class="card-body p-4">
                <div class="row g-3">
                  <!-- Nombre -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        [class.is-invalid]="
                          userForm.get('nombre')?.invalid &&
                          (userForm.get('nombre')?.touched ||
                            userForm.get('nombre')?.dirty)
                        "
                        id="name"
                        placeholder="Ingresa tu nombre"
                        formControlName="nombre"
                      />
                      <label for="name" class="form-label text-blanco"
                        >Nombre</label
                      >
                      @if (userForm.get('nombre')?.errors?.['required'] &&
                      (userForm.get('nombre')?.touched ||
                      userForm.get('nombre')?.dirty)) {
                      <div class="invalid-feedback">
                        El nombre es obligatorio
                      </div>
                      } @if (userForm.get('nombre')?.errors?.['pattern']) {
                      <div class="invalid-feedback">
                        Debe tener al menos 2 letras y solo caracteres válidos
                      </div>
                      }
                    </div>
                  </div>

                  <!-- Apellidos -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        [class.is-invalid]="
                          userForm.get('apellidos')?.invalid &&
                          (userForm.get('apellidos')?.touched ||
                            userForm.get('apellidos')?.dirty)
                        "
                        id="apellidos"
                        placeholder="Ingresa tus apellidos"
                        formControlName="apellidos"
                      />
                      <label for="apellidos" class="form-label text-blanco"
                        >Apellidos</label
                      >
                      @if (userForm.get('apellidos')?.errors?.['required'] &&
                      (userForm.get('apellidos')?.touched ||
                      userForm.get('apellidos')?.dirty)) {
                      <div class="invalid-feedback">
                        Los apellidos son obligatorios
                      </div>
                      } @if (userForm.get('apellidos')?.errors?.['pattern']) {
                      <div class="invalid-feedback">
                        Formato inválido (mínimo 2 letras por apellido)
                      </div>
                      }
                    </div>
                  </div>

                  <!-- Email -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="email"
                        class="form-control"
                        [class.is-invalid]="
                          userForm.get('email')?.invalid &&
                          (userForm.get('email')?.touched ||
                            userForm.get('email')?.dirty)
                        "
                        id="email"
                        placeholder="Ingresa tu email"
                        formControlName="email"
                      />
                      <label for="email" class="form-label text-blanco"
                        >Email</label
                      >
                      @if (userForm.get('email')?.errors?.['required'] &&
                      (userForm.get('email')?.touched ||
                      userForm.get('email')?.dirty)) {
                      <div class="invalid-feedback">
                        El email es obligatorio
                      </div>
                      } @if (userForm.get('email')?.errors?.['pattern']) {
                      <div class="invalid-feedback">
                        Formato de email inválido
                      </div>
                      }
                    </div>
                  </div>

                  <!-- Teléfono -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control"
                        [class.is-invalid]="
                          userForm.get('telefono')?.invalid &&
                          (userForm.get('telefono')?.touched ||
                            userForm.get('telefono')?.dirty)
                        "
                        id="telefono"
                        placeholder="Ej: 612345678"
                        formControlName="telefono"
                      />
                      <label for="telefono" class="form-label text-blanco"
                        >Teléfono</label
                      >
                      @if (userForm.get('telefono')?.errors?.['required'] &&
                      (userForm.get('telefono')?.touched ||
                      userForm.get('telefono')?.dirty)) {
                      <div class="invalid-feedback">
                        El teléfono es obligatorio
                      </div>
                      } @if (userForm.get('telefono')?.errors?.['pattern']) {
                      <div class="invalid-feedback">
                        Debe tener entre 9 y 15 dígitos
                      </div>
                      }
                    </div>
                  </div>

                  <!-- Contraseña -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="password"
                        class="form-control"
                        [class.is-invalid]="
                          userForm.get('password')?.invalid &&
                          (userForm.get('password')?.touched ||
                            userForm.get('password')?.dirty)
                        "
                        id="password"
                        placeholder="Ingresa tu contraseña"
                        formControlName="password"
                      />
                      <label for="password" class="form-label text-blanco"
                        >Contraseña</label
                      >
                      @if (userForm.get('password')?.errors?.['required'] &&
                      (userForm.get('password')?.touched ||
                      userForm.get('password')?.dirty)) {
                      <div class="invalid-feedback">
                        La contraseña es obligatoria
                      </div>
                      } @if (userForm.get('password')?.errors?.['pattern']) {
                      <div class="invalid-feedback">
                        Mínimo 8 caracteres, una mayúscula, una minúscula y un
                        número
                      </div>
                      }
                    </div>
                  </div>

                  <!-- Confirmar Contraseña -->
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input
                        type="password"
                        class="form-control"
                        [class.is-invalid]="
                          (userForm.get('passwordConfirm')?.invalid &&
                            (userForm.get('passwordConfirm')?.touched ||
                              userForm.get('passwordConfirm')?.dirty)) ||
                          (userForm.hasError('mismatch') &&
                            userForm.get('passwordConfirm')?.dirty)
                        "
                        id="passwordConfirm"
                        placeholder="Repite la contraseña"
                        formControlName="passwordConfirm"
                      />
                      <label
                        for="passwordConfirm"
                        class="form-label text-blanco"
                        >Repetir contraseña</label
                      >
                      @if (userForm.get('passwordConfirm')?.errors?.['required']
                      && (userForm.get('passwordConfirm')?.touched ||
                      userForm.get('passwordConfirm')?.dirty)) {
                      <div class="invalid-feedback">
                        Debes repetir la contraseña
                      </div>
                      } @if (userForm.hasError('mismatch') &&
                      userForm.get('passwordConfirm')?.dirty) {
                      <div class="invalid-feedback">
                        Las contraseñas no coinciden
                      </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dirección de envío -->
            <div class="card border-morado-intermedio-1 rounded-4 mt-4">
              <div
                class="card-header bg-morado-intermedio-1 text-blanco rounded-top-3"
              >
                <h5 class="mb-0 bold">Dirección de Envío</h5>
              </div>
              <div class="card-body p-4">
                <div class="row g-3">
                  <div class="col-12">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control border-morado-intermedio-1"
                        [class.is-invalid]="
                          userForm.get('direccion')?.invalid &&
                          (userForm.get('direccion')?.touched ||
                            userForm.get('direccion')?.dirty)
                        "
                        id="direccion"
                        placeholder="Dirección"
                        formControlName="direccion"
                      />
                      <label for="direccion" class="text-morado-oscuro"
                        >Dirección</label
                      >
                      @if (userForm.get('direccion')?.errors?.['required'] &&
                      (userForm.get('direccion')?.touched ||
                      userForm.get('direccion')?.dirty)) {
                      <div class="invalid-feedback">
                        La dirección es obligatoria
                      </div>
                      }
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control border-morado-intermedio-1"
                        [class.is-invalid]="
                          userForm.get('codigoPostal')?.invalid &&
                          (userForm.get('codigoPostal')?.touched ||
                            userForm.get('codigoPostal')?.dirty)
                        "
                        id="codigoPostal"
                        placeholder="Código postal"
                        formControlName="codigoPostal"
                      />
                      <label for="codigoPostal" class="text-morado-oscuro"
                        >Código postal</label
                      >
                      @if (userForm.get('codigoPostal')?.errors?.['required'] &&
                      (userForm.get('codigoPostal')?.touched ||
                      userForm.get('codigoPostal')?.dirty)) {
                      <div class="invalid-feedback">
                        El código postal es obligatorio
                      </div>
                      } @if (userForm.get('codigoPostal')?.errors?.['pattern'])
                      {
                      <div class="invalid-feedback">
                        Formato de código postal inválido
                      </div>
                      }
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control border-morado-intermedio-1"
                        [class.is-invalid]="
                          userForm.get('ciudad')?.invalid &&
                          (userForm.get('ciudad')?.touched ||
                            userForm.get('ciudad')?.dirty)
                        "
                        id="ciudad"
                        placeholder="Ciudad"
                        formControlName="ciudad"
                      />
                      <label for="ciudad" class="text-morado-oscuro"
                        >Ciudad</label
                      >
                      @if (userForm.get('ciudad')?.errors?.['required'] &&
                      (userForm.get('ciudad')?.touched ||
                      userForm.get('ciudad')?.dirty)) {
                      <div class="invalid-feedback">
                        La ciudad es obligatoria
                      </div>
                      }
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control border-morado-intermedio-1"
                        [class.is-invalid]="
                          userForm.get('provincia')?.invalid &&
                          (userForm.get('provincia')?.touched ||
                            userForm.get('provincia')?.dirty)
                        "
                        id="provincia"
                        placeholder="Provincia"
                        formControlName="provincia"
                      />
                      <label for="provincia" class="text-morado-oscuro"
                        >Provincia</label
                      >
                      @if (userForm.get('provincia')?.errors?.['required'] &&
                      (userForm.get('provincia')?.touched ||
                      userForm.get('provincia')?.dirty)) {
                      <div class="invalid-feedback">
                        La provincia es obligatoria
                      </div>
                      }
                    </div>
                  </div>

                  <div class="col-md-12">
                    <div class="form-floating">
                      <input
                        type="text"
                        class="form-control border-morado-intermedio-1"
                        [class.is-invalid]="
                          userForm.get('pais')?.invalid &&
                          (userForm.get('pais')?.touched ||
                            userForm.get('pais')?.dirty)
                        "
                        id="pais"
                        placeholder="País"
                        formControlName="pais"
                      />
                      <label for="pais" class="text-morado-oscuro">País</label>
                      @if (userForm.get('pais')?.errors?.['required'] &&
                      (userForm.get('pais')?.touched ||
                      userForm.get('pais')?.dirty)) {
                      <div class="invalid-feedback">El país es obligatorio</div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botón de guardado unificado -->
            <div class="text-end mt-4">
              <button
                type="submit"
                class="btnSinIcono py-2 px-4"
                style="width: auto"
              >
                Guardar cambios del perfil
              </button>
            </div>
          </form>
        </div>

        <!-- Panel lateral -->
        <div class="col-lg-4">
          <!-- Estadísticas -->
          <div class="card border-morado-intermedio-1 rounded-4">
            <div class="card-header bg-morado-claro">
              <h6 class="mb-0 text-morado-oscuro bold">Resumen de actividad</h6>
            </div>
            <div class="card-body p-4">
              <div class="d-flex justify-content-between mb-3">
                <span class="text-morado-oscuro">Pedidos realizados:</span>
                <span class="text-morado-intermedio-1 bold">{{
                  numPedidosUser()
                }}</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-morado-oscuro">Productos favoritos:</span>
                <span class="text-morado-intermedio-1 bold">{{
                  numProductosFavoritos()
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pestaña Mis Pedidos -->
    <div
      class="tab-pane fade"
      id="pedidos"
      role="tabpanel"
      aria-labelledby="pedidos-tab"
    >
      <div class="row">
        <div class="col-12">
          <!-- Filtros de pedidos -->
          <div class="mb-4">
            <div class="card-body p-3">
              <div class="row g-3 align-items-center">
                <div class="col-md-4">
                  <select
                    class="form-select border-morado-intermedio-1"
                    (change)="filtrarPorEstado($event)"
                  >
                    <option value="todos" selected>Todos los pedidos</option>
                    @for (estado of estadosPedidos(); track estado) {
                    <option [value]="estado[1]">{{ estado[0] }}</option>
                    }
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Lista de pedidos -->
          <div class="row g-4">
            @if (pedidosUserFiltrados()!.length === 0) {
              <div class="col-12 text-center mt-5">
                <p class="text-muted mt-3 fs-5">No tienes pedidos en este estado.</p>
              </div>
            } @else {
            @for (pedido of pedidosUserFiltrados(); track pedido.id) {
            <div class="col-12">
              <div class="card border-morado-intermedio-1 rounded-4">
                <div class="card-body p-4">
                  <div class="row align-items-top">
                    <div class="col-md-2">
                      <div class="py-2">
                        <h5 class="text-morado-oscuro bold mb-1">
                          Pedido #{{ pedido.id }}
                        </h5>
                        <small class="text-morado-oscuro">{{
                          pedido.fecha | date : "dd/MM/yyyy"
                        }}</small>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="d-flex flex-column gap-2">
                        @for (linea of lineasPorPedido().get(pedido.id!); track
                        linea.id) {
                        <div class="d-flex align-items-center">
                          <div
                            class="bg-morado-claro rounded me-3"
                            style="width: 60px; height: 60px; overflow: hidden"
                          >
                            <img
                              [src]="linea.productoDTO.urlImagen"
                              alt="Producto"
                              class="img-fluid w-100 h-100 object-fit-cover"
                            />
                          </div>

                          <div>
                            <h6 class="text-morado-oscuro bold mb-1">
                              {{ linea.productoDTO.nombre }}
                            </h6>
                            <p class="text-morado-oscuro small mb-0">
                              {{ linea.cantidad }} producto{{
                                linea.cantidad! > 1 ? "s" : ""
                              }}
                              •
                              {{
                                (linea.productoDTO?.precio ?? 0) *
                                  linea.cantidad! | precioEuro
                              }}
                            </p>
                          </div>
                        </div>

                        }
                      </div>
                    </div>

                    <div class="col-md-2">
                      <h5 class="text-morado-oscuro bold mb-1">
                        {{ pedido.importe! | precioEuro }}
                      </h5>
                    </div>

                    @if (pedido.estado === "completado") {
                    <div class="col-md-2 text-center">
                      <span
                        class="badge bg-verde text-blanco rounded-pill px-3 py-2"
                      >
                        Completado
                      </span>
                    </div>
                    } @else if (pedido.estado === "cancelado") {
                    <div class="col-md-2 text-center">
                      <span
                        class="badge bg-rojo text-blanco rounded-pill px-3 py-2"
                      >
                        Cancelado
                      </span>
                    </div>
                    } @else if (pedido.estado === "pendiente") {
                    <div class="col-md-2 text-center">
                      <span
                        class="badge bg-morado-intermedio-1 text-blanco rounded-pill px-3 py-2"
                      >
                        Pendiente
                      </span>
                    </div>
                    }
                  </div>
                </div>
              </div>
            </div>
            }
          }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
